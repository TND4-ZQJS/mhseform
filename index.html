<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MHSE Guaranteed Conversion Program</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:15px 0 35px 0;font-size:1.50rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=number],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  textarea{resize:vertical;min-height:120px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}


  /* Signature preview tiles */
  .sig-preview{
    width:100%; height:150px; border:1px dashed #bbb; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative;
  }
  .sig-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
  .sig-preview span{ color:#999; }

  /* Signature Modal */
  .sig-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; }
  .sig-modal .box{
    width:min(560px, 92vw); background:#fff; margin:6vh auto; padding:14px; border-radius:12px;
    box-shadow:0 18px 50px rgba(0,0,0,.25)
  }
  .sig-modal h3{ margin:0 0 8px 0; }
  /* NOTE: canvas is responsive via CSS; internal pixels are set in JS for crispness */
  #sigCanvas{ width:100%; height:220px; background:#fff; border:1px solid #ddd; border-radius:10px; touch-action:none }
  .sig-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

  /* Hidden signature XY tuning inputs (owner/witness) */
  .hidden-inputs {display: none;}

  /* Preview pane */
  .preview{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
  .preview canvas{width:100%;height:auto;border-radius:8px}

  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  @media (max-width:720px){
    .policy-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main>
  <h1>MHSE Guaranteed Conversion Program (LF1047)</h1>

  <!-- SECTION: Policy Info -->
  <section class="section">
    <h2>Proposed Life Insured Info</h2>

    <label>Policy No.
      <input id="MHSE_Info_PolicyNo" class="persist" type="text" placeholder="Enter policy no.">
    </label>

    <div class="row">
      <label style="flex:1">Insured's Name
        <input id="MHSE_Info_InsName" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>
    <div class="row">
      <label style="flex:1">Insured's IC No.
        <input id="MHSE_Info_InsNIRC" class="persist" type="text" placeholder="e.g. 900101-14-1234">
      </label>
    </div>

    <div class="row">
      <label style="flex:1">Policy Owner's Name
        <input id="MHSE_Info_POName" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>
    <div class="row">
      <label style="flex:1">Policy Owner's Mobile No.
        <input id="MHSE_Info_POMobile" class="persist" type="text" placeholder="e.g. 012-23456789">
      </label>
      <label style="flex:1">Policy Owner's E-mail
        <input id="MHSE_Info_POEmail" class="persist" type="text" placeholder="Enter email">
      </label>
    </div>
  </section>

 <!-- SECTION: Only MHE and MHC -->
   <section class="section">
    <h2>Only applicable for ManuHealth Elite and Manulife Health Cover Ordinary Life Plan</h2>

    <label><input id="MHSE_TerminateStandalone" class="persist" type="checkbox">
      I hereby agree to terminate my existing Ordinary Life Plan for conversion to the New Investment Link Plan.
    </label>
   </section>

  <!-- SECTION: MHSE Options -->
  <section class="section">
    <h2>MHSE Options</h2>
    
    <section class="section">
    <label style="flex:1">Deductible Option</label>
        <div class="row">
      <label class="inline"><input name="Deductibletype" class="persist" id="MHSE_Deductible_500" type="radio">RM500</label>
      <label class="inline"><input name="Deductibletype" class="persist" id="MHSE_Deductible_1k" type="radio">RM1000</label>
      <label class="inline"><input name="Deductibletype" class="persist" id="MHSE_Deductible_5k" type="radio">RM5000</label>
      <label class="inline"><input name="Deductibletype" class="persist" id="MHSE_Deductible_10k" type="radio">RM10,000</label>
        </div>
    </section>

       <section class="section">
    <label style="flex:1">Plan Option</label>
        <div class="row">
      <label class="inline"><input name="Plantype" class="persist" id="MHSE_Plan_200" type="radio">MHSE Plan 200</label>
      <label class="inline"><input name="Plantype" class="persist" id="MHSE_Plan_300" type="radio">MHSE Plan 300</label>
      <label class="inline"><input name="Plantype" class="persist" id="MHSE_Plan_1000" type="radio">MHSE Plan 1000</label>
        </div>
    </section>

    <section class="section">
    <label style="flex:1">Optional</label>
        <div class="row">
      <label style="flex:1"><input name="optionalTopup" class="persist" id="MHSE_IncPremium_Check" type="checkbox">Increase Basic Plan Insurance Premium</label>
          <input type="text" class="persist" id="MHSE_IncPremium_Amount" placeholder="Enter Basic Premium Top-Up Amount">
    </section>

    <section class="section">
    <label style="flex:1">Optional</label>
        <div class="row">
      <label style="flex:1"><input name="optionalTopup" class="persist" id="MHSE_AddRegularTU_Check" type="checkbox">Add regular top-up Premium</label>
          <input type="text" class="persist" id="MHSE_AddRegularTU_Amount" placeholder="Enter Regular Top-Up Amount">
    </section>
  </section>

    <!-- SECTION: MHSE Options -->
  <section class="section">
     <h2>E-Banking Facilty</h2>
    
     <div class="row">
      <label style="flex:1"><input id="MHSE_Ebanking_Check" class="persist" type="checkbox">Request for E-Banking Facility (Compulsory)</label>
     </div>

       <div class="row">
      <label style="flex:1">Payee's Name
        <input id="MHSE_EBanking_Name" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>

       <div class="row">
      <label style="flex:1">IC No. (as per bank's record)
        <input id="MHSE_EBanking_NIRC" class="persist" type="text" placeholder="e.g. 900101-14-1234">
      </label>
    </div>

      <div class="row">
      <label style="flex:1">Account No.
        <input id="MHSE_EBanking_BankAcc" class="persist" type="text" placeholder="Enter account no.">
      </label>
    </div>

      <div class="row">
      <label style="flex:1">Bank Name
        <input id="MHSE_EBanking_BankName" class="persist" type="text" placeholder="Enter bank name">
      </label>
    </div>

      <section class="section">
    <label style="flex:1">Account Type</label>
        <div class="row">
      <label class="inline"><input name="Banktype" class="persist" id="MHSE_EBanking_Islamic" type="radio">Islamic</label>
      <label class="inline"><input name="Banktype" class="persist" id="MHSE_EBanking_Conventional" type="radio">Conventional</label>
        </div>
    </section>
  </section>
    
  <!-- SECTION: Signature Details (Date/Place) -->
  <section class="section">
    <h2>Signature Details</h2>
    <div class="row">
      <label style="flex:1">Signed at (State)
        <select id="MHSE_Sign_State" class="persist">
          <option value="">-- Select State --</option>
          <!-- Same bel set used in your reference -->
          <option>SELANGOR</option><option>K.LUMPUR</option><option>MELAKA</option><option>JOHOR</option>
          <option>N.SEMBILAN</option><option>PENANG</option><option>PERAK</option><option>SABAH</option>
          <option>SARAWAK</option><option>KELANTAN</option><option>PERLIS</option><option>T'GANU</option>
          <option>PAHANG</option><option>KEDAH</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label style="flex:1">Day
        <select id="MHSE_Sign_Date" class="persist">
          <option value="">-- Day (DD) --</option>
          <option>01</option><option>02</option><option>03</option><option>04</option>
          <option>05</option><option>06</option><option>07</option><option>08</option>
          <option>09</option><option>10</option><option>11</option><option>12</option>
          <option>13</option><option>14</option><option>15</option><option>16</option>
          <option>17</option><option>18</option><option>19</option><option>20</option>
          <option>21</option><option>22</option><option>23</option><option>24</option>
          <option>25</option><option>26</option><option>27</option><option>28</option>
          <option>29</option><option>30</option><option>31</option>
        </select>
      </label>
      <label style="flex:1">Month
        <select id="MHSE_Sign_Month" class="persist">
          <option value="">-- Month --</option>
          <option>JANUARY</option><option>FEBRUARY</option><option>MARCH</option><option>APRIL</option>
          <option>MAY</option><option>JUNE</option><option>JULY</option><option>AUGUST</option>
          <option>SEPTEMBER</option><option>OCTOBER</option><option>NOVEMBER</option><option>DECEMBER</option>
        </select>
      </label>
      <label style="flex:1">Year
        <select id="MHSE_Sign_Year" class="persist">
          <option value="">-- Year (YYYY) --</option>
          <option>2025</option><option>2026</option>
        </select>
      </label>
    </div>
  </section>

  <!-- SECTION: Owner/Policyowner Signature -->
  <section class="section">
    <h2>Signature of Policy Owner/Assignee</h2>
    <div class="row">
      <label style="flex:1">Policyowner/Assignee Name
        <input id="MHSE_Sign_POName" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>
    <div class="row">
    <label style="flex:1">IC No.
        <input id="MHSE_Sign_PONIRC" class="persist" type="text" placeholder="e.g. 900101-14-1234">
    </label>
    </div>

        <div class="sig-preview" id="preview_owner" onclick="openSig('owner')">
      <span>Tap to Sign (Policyowner)</span>
    </div>
    <div class="row">
      <button id="clearPreviewOwner" class="secondary" type="button">Clear Signature</button>
    </div>
  </section>

  <!-- SECTION: Witness Signature -->
  <section class="section">
    <h2>Signature of Witness</h2>
    <div class="row">
      <label style="flex:1">Name of Witness
        <input id="MHSE_Sign_WitnessName" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>
    <div class="row">
      <label style="flex:1">IC No.
        <input id="MHSE_Sign_WitnessNIRC" class="persist" type="text" placeholder="e.g. 800202-08-5678">
      </label>
      <label style="flex:1">Mobile No.
        <input id="MHSE_Sign_WitnessTel" class="persist" type="text" placeholder="e.g. 012-23456789">
      </label>
    </div>

    <div class="sig-preview" id="preview_witness" onclick="openSig('witness')">
      <span>Tap to Sign (Witness)</span>
    </div>
    <div class="row">
      <button id="clearPreviewWitness" class="secondary" type="button">Clear Signature</button>
    </div>
  </section>
  
    <!-- SECTION: Trustee -->
  <section class="section">
    <h2>Signature of Trustee</h2>
    <div class="row">
      <label style="flex:1">Trustee Name
        <input id="MHSE_Sign_TrusteeName" class="persist" type="text" placeholder="Enter name">
      </label>
    </div>
    <div class="row">
    <label style="flex:1">IC No.
        <input id="MHSE_Sign_TrusteeNIRC" class="persist" type="text" placeholder="e.g. 900101-14-1234">
    </label>
    </div>


    <div class="sig-preview" id="preview_trustee" onclick="openSig('trustee')">
      <span>Tap to Sign (Trustee)</span>
    </div>
    <div class="row">
      <button id="clearPreviewTrustee" class="secondary" type="button">Clear Signature</button>
    </div>
  </section>
    
    <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

  
    <div id="sigModal" class="sig-modal" aria-hidden="true">
  <div class="box">
    <h3 id="sigModalTitle">Draw Signature</h3>
    <!-- Responsive canvas: internal pixels are set in JS for crispness -->
    <canvas id="sigCanvas"></canvas>
    <div class="sig-actions">
      <button id="sigDone" type="button">Done</button>
      <button id="sigClear" type="button" class="ghost">Clear</button>
      <button id="sigCancel" type="button" class="secondary">Cancel</button>
    </div>
  </div>
</div>
    <div id="saveStatus">Saved</div>
  </section>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>

  function $(id) {
  return document.getElementById(id);
}
  
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "CampaignApplicationForm_LF1047_fillable.pdf";

/* ---SAVE STATUS + LOCALSTORAGE (Text, Checkbox, Dropdown) ---------- */
const saveStatusEl = document.getElementById("saveStatus");

function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}

function saveElValue(el){
  localStorage.setItem(el.id, el.value);
  showSaveStatus();
}

function autoBindSave(el) {
  const saved = localStorage.getItem(el.id);

  // Restore
  if (el.type === "checkbox") {
    if (saved !== null) el.checked = (saved === "true");
  } else if (el.type === "radio") {
    const savedRadioValue = localStorage.getItem(el.name);
    if (savedRadioValue) {
      el.checked = (el.id === savedRadioValue);
    }
  } else if (saved !== null) {
    el.value = saved;
  }

  // Bind save
  if (el.tagName === "SELECT") {
    el.addEventListener("change", () => saveElValue(el));
  } else if (el.type === "checkbox") {
    el.addEventListener("change", () => {
      localStorage.setItem(el.id, el.checked);
      showSaveStatus();
    });
  } else if (el.type === "radio") {
    el.addEventListener("change", () => {
      if (el.checked) {
        localStorage.setItem(el.name, el.id); // store under group name
        showSaveStatus();
      }
    });
} else {
  el.addEventListener("input", () => {
    if (el.id !== "MHSE_Info_POEmail") { //except Email
      el.value = el.value.toUpperCase();   // update textbox itself
    }
    localStorage.setItem(el.id, el.value);
    showSaveStatus();
  });
}
}

  
/* ---------- UNIVERSAL HELPER FUNCTION ---------- */

  //Detect input type - text/dropdown/checkbox/radio
function safeSetField(form, fieldName, value) {
  if (value === null || value === undefined) return;

  try {
    let field;

    // text or textarea, then force Uppercase
    try {
      field = form.getTextField(fieldName);
      // Keep original case for email
      if (fieldName === "MHSE_Info_POEmail") {
        field.setText(value);
      } else {
        field.setText(value.toUpperCase());
      }
      return;
    } catch (e) {}

    // dropdown
    try {
      field = form.getDropdown(fieldName);
      field.select(value);
      return;
    } catch (e) {}

    // checkbox
    try {
      field = form.getCheckBox(fieldName);
      if (value === true || value === "true" || value === "on" || value === "checked") {
        field.check();
      } else {
        field.uncheck();
      }
      return;
    } catch (e) {}

    // radio
    try {
      field = form.getRadioGroup(fieldName);
      field.select(value);
      return;
    } catch (e) {}

    console.warn(`Field ${fieldName} not found in PDF`);
  } catch (err) {
    console.error(`Error setting field ${fieldName}`, err);
  }
}


/* ---------- SIGNATURE MODAL LOGIC ---------- */
let sigTarget = null;
const sigModal = $("sigModal");
const sigCanvas = $("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");

const signaturePad = new SignaturePad(sigCanvas, {
  minWidth: 0.7,              // Thin lines when moving fast
  maxWidth: 2.5,              // Thicker when moving slowly
  velocityFilterWeight: 0.6,  // More responsive to speed, but still smooth
  minDistance: 3,             // Capture detail without too many points
  throttle: 16,               // ~60 FPS, smooth without lag
  penColor: "black",          // Signature color
  backgroundColor: "rgba(0,0,0,0)" // Transparent background
  //minWidth: 1,
  //maxWidth: 3,
  //penColor: "black",
  //backgroundColor: "rgba(0,0,0,0)"
});

function resizeCanvas() {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);

  // If modal is open and sigTarget exists, prefer the stored PNG for that role.
  // Otherwise fall back to the current canvas content.
  const storageKey = sigTarget ? "mhse_sig_" + sigTarget : null;
  const savedFromStorage = storageKey ? localStorage.getItem(storageKey) : null;
  const sourceData = savedFromStorage || sigCanvas.toDataURL();

  // Set canvas size in device pixels (prevent subpixel rounding issues)
  sigCanvas.width = Math.floor(sigCanvas.offsetWidth * ratio);
  sigCanvas.height = Math.floor(sigCanvas.offsetHeight * ratio);

  // Reset transform and set scale so drawing coordinates are in CSS pixels
  sigCtx.setTransform(ratio, 0, 0, ratio, 0, 0);

  // CSS size (in drawing units now) for layout math
  const cssW = sigCanvas.offsetWidth;
  const cssH = sigCanvas.offsetHeight;

  // If we have an image source (PNG), draw it proportionally and center it
  if (sourceData && typeof sourceData === "string" && sourceData.indexOf("data:image") === 0) {
    const img = new Image();
    img.onload = () => {
      // clear using CSS coordinate space
      sigCtx.clearRect(0, 0, cssW, cssH);

      // Scale image proportionally to fit inside canvas area (CSS pixels)
      const scale = Math.min(cssW / img.width, cssH / img.height);
      const x = (cssW - img.width * scale) / 2;
      const y = (cssH - img.height * scale) / 2;

      // draw using CSS units (ctx is already scaled by devicePixelRatio)
      sigCtx.drawImage(img, x, y, img.width * scale, img.height * scale);
    };
    img.src = sourceData;
  } else {
    // No image to draw — clear the pad so it's ready for a new signature
    signaturePad.clear();
  }
}
window.addEventListener("resize", resizeCanvas);

function openSig(target){
  sigTarget = target;
  $("sigModalTitle").textContent = 
    target === 'owner' ? "Sign: Policy Owner" :
    target === 'witness' ? "Sign: Witness" : "Sign: Trustee";

  sigModal.style.display = "block";
  sigModal.setAttribute("aria-hidden", "false");

  // Wait for layout to settle then resize & restore (resizeCanvas will restore the saved PNG if present)
  requestAnimationFrame(()=>{
    resizeCanvas();
  });
}

$("sigClear").addEventListener("click", ()=>{
  signaturePad.clear();

  if (sigTarget) {
    // remove saved signature
    localStorage.removeItem("mhse_sig_" + sigTarget);

    // reset preview back to "Tap to Sign (…) "
    $("preview_" + sigTarget).innerHTML = `<span>Tap to Sign (${
      sigTarget.charAt(0).toUpperCase() + sigTarget.slice(1)
    })</span>`;
  }
});
  
$("sigCancel").addEventListener("click", closeSigModal);
function closeSigModal(){
  sigModal.style.display = "none";
  sigModal.setAttribute("aria-hidden", "true");
  sigTarget = null;
}
  
$("sigDone").addEventListener("click", () => {
  if (!sigTarget) return;

  // Always take snapshot from the canvas (even if unchanged)
  const dataURL = sigCanvas.toDataURL("image/png");

  if (signaturePad.isEmpty() && !localStorage.getItem("mhse_sig_" + sigTarget)) {
    // If no strokes and nothing saved before → treat as empty
    const label = sigTarget.charAt(0).toUpperCase() + sigTarget.slice(1);
    $("preview_" + sigTarget).innerHTML = `<span>Tap to Sign (${label})</span>`;
    localStorage.removeItem("mhse_sig_" + sigTarget);
  } else {
    // Save whatever is currently visible on the canvas
    localStorage.setItem("mhse_sig_" + sigTarget, dataURL);
    $("preview_" + sigTarget).innerHTML = `<img alt="Signature ${sigTarget}" src="${dataURL}">`;
  }

  closeSigModal();
});



/* Clear preview buttons + restore previews on load */
$("clearPreviewOwner").addEventListener("click", ()=>{
  localStorage.removeItem("mhse_sig_owner");
  $("preview_owner").innerHTML = `<span>Tap to Sign (Owner)</span>`;

  // also clear from canvas if modal currently showing owner
  if (sigTarget === "owner") signaturePad.clear();
});

$("clearPreviewWitness").addEventListener("click", ()=>{
  localStorage.removeItem("mhse_sig_witness");
  $("preview_witness").innerHTML = `<span>Tap to Sign (Witness)</span>`;

  if (sigTarget === "witness") signaturePad.clear();
});

$("clearPreviewTrustee").addEventListener("click", ()=>{
  localStorage.removeItem("mhse_sig_trustee");
  $("preview_trustee").innerHTML = `<span>Tap to Sign (Trustee)</span>`;

  if (sigTarget === "trustee") signaturePad.clear();
});

window.addEventListener("DOMContentLoaded", ()=>{
  ["owner","witness","trustee"].forEach(role=>{
    const saved = localStorage.getItem("mhse_sig_"+role);
    if(saved){
      $("preview_"+role).innerHTML = `<img alt="Signature ${role}" src="${saved}">`;
    }
  });
});


/* ---------- GENERATE PDF ---------- */
async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

    const pages = pdfDoc.getPages();
    const page = pages[1]; // use first page

    /* ===== RADIO (UI) -> PDF CHECKBOX (fields) MAPPING ===== */
// helper to map a radio group (saved under groupName) to a list of PDF checkbox field names
function mapRadioGroupToPdfCheckboxes(groupName, pdfCheckboxNames) {
  const selectedId = localStorage.getItem(groupName); // e.g. "MHSE_Deductible_1000"
  // For safety, uncheck all first then check the selected one
  pdfCheckboxNames.forEach(fieldName => {
    const shouldCheck = (fieldName === selectedId);
    safeSetField(form, fieldName, shouldCheck); // safeSetField knows how to check/uncheck
  });
}

// Deductible option (UI name: "Deductibletype")
mapRadioGroupToPdfCheckboxes("Deductibletype", [
  "MHSE_Deductible_500",
  "MHSE_Deductible_1k",
  "MHSE_Deductible_5k",
  "MHSE_Deductible_10k"
]);

// Plan option (UI name: "Plantype")
mapRadioGroupToPdfCheckboxes("Plantype", [
  "MHSE_Plan_200",
  "MHSE_Plan_300",
  "MHSE_Plan_1000"
]);

// Account type (UI name: "Banktype")
mapRadioGroupToPdfCheckboxes("Banktype", [
  "MHSE_EBanking_Islamic",
  "MHSE_EBanking_Conventional"
]);
/* ===== end mapping ===== */

 

    // FILL FORM FIELDS FROM LOCALSTORAGE HERE
[
  "MHSE_Info_InsName",
  "MHSE_Info_PolicyNo",
  "MHSE_Info_InsNIRC",
  "MHSE_Info_POName",
  "MHSE_Info_POMobile",
  "MHSE_Info_POEmail",
  "MHSE_TerminateStandalone",
  "MHSE_IncPremium_Check",
  "MHSE_IncPremium_Amount",
  "MHSE_AddRegularTU_Check",
  "MHSE_AddRegularTU_Amount",
  "MHSE_Ebanking_Check",
  "MHSE_EBanking_Name",
  "MHSE_EBanking_NIRC",
  "MHSE_EBanking_BankAcc",
  "MHSE_EBanking_BankName",
  "MHSE_Sign_State",
  "MHSE_Sign_Date",
  "MHSE_Sign_Month",
  "MHSE_Sign_Year",
  "MHSE_Sign_POName", 
  "MHSE_Sign_PONIRC", 
  "MHSE_Sign_WitnessName",
  "MHSE_Sign_WitnessNIRC",
  "MHSE_Sign_WitnessTel",
  "MHSE_Sign_TrusteeName",
  "MHSE_Sign_TrusteeNIRC"
].forEach(fieldName => {
  safeSetField(form, fieldName, localStorage.getItem(fieldName));
});

    
    /* --------- SIGNATURE IMAGE EMBEDDING (embedPng + drawImage) --------- */

// Owner signature FillPDF
const sigOwner = localStorage.getItem("mhse_sig_owner");
if (sigOwner) {
  try {
    const imgOwner = await pdfDoc.embedPng(sigOwner);
    const { width, height } = imgOwner.size();

    const previewEl = document.getElementById("preview_owner");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.35;    // % scale
    const posX = 50;         // X position on PDF
    const posY = 175;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgOwner, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}

// Witness signature FillPDF
const sigWitness = localStorage.getItem("mhse_sig_witness");
if (sigWitness) {
  try {
    const imgWitness = await pdfDoc.embedPng(sigWitness);
    const { width, height } = imgWitness.size();

    const previewEl = document.getElementById("preview_witness");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.35;    // % scale
    const posX = 410;         // X position on PDF
    const posY = 175;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgWitness, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}


// Trustee signature FillPDF
const sigTrustee = localStorage.getItem("mhse_sig_trustee");
if (sigTrustee) {
  try {
    const imgTrustee = await pdfDoc.embedPng(sigTrustee);
    const { width, height } = imgTrustee.size();

    const previewEl = document.getElementById("preview_trustee");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.35;    // % scale
    const posX = 230;         // X position on PDF
    const posY = 175;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgTrustee, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}
    
    // Flatten form fields before saving
    form.flatten();
    
    // Save & download FillPDF
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_MHSECampaign_Form.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch(err){
    alert("PDF generation failed: " + (err.message || err));
    console.error(err);
  } finally {
    $("generate").disabled = false;
  }
}


/* ---------- RESET ALL DATA function ---------- */
function resetAll() {
  if (!confirm("Are you sure you want to reset the form? All saved data will be cleared.")) {
    return;
  }

  // 1) Clear ALL saved keys that belong to this form
  //    (Everything starting with "Nom_" plus legacy signature keys)
  const keys = Object.keys(localStorage);
  keys.forEach(k => {
    if (k.startsWith("Nom_")) localStorage.removeItem(k);
  });
  // Legacy sig keys (if you still use these)
  ["sig_owner","sig_witness","sig_trustee"].forEach(k => localStorage.removeItem(k));

  // 2) Clear the live UI values for Section A/E (inputs that remain in DOM)
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (!el.id) return;
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });


  // 3) Reset signature previews
  $("preview_owner").innerHTML   = `<span>Tap to Sign (Policy Owner)</span>`;
  $("preview_witness").innerHTML = `<span>Tap to Sign (Witness)</span>`;
  $("preview_trustee").innerHTML = `<span>Tap to Sign (Trustee)</span>`;

  showSaveStatus();
}

  /* ---------- Wire buttons ---------- */
$("generate").addEventListener("click", fillPDF);
$("resetAll").addEventListener("click", resetAll);
document.querySelectorAll(".persist").forEach(autoBindSave);

  
</script>
</main> 
</body>
</html>
